# B17.6 Temporal Hygiene — Outcome Summary

**Mission:** B17.6 - Temporal Hygiene (dual time & tz)  
**Sprint:** 17  
**Status:** ✅ Completed  
**Started:** 2025-10-25T14:00:00Z  
**Completed:** 2025-10-25T14:45:00Z  
**Duration:** 45 minutes

## Objective

Adopt the dual-time convention (business vs system time) and standardize timestamptz handling across billing/compliance domains to eliminate drift and timezone bugs.

## Deliverables Shipped

### 1. Policy & Documentation

✅ **docs/policies/time.md** - Complete dual-time specification
- Business time vs system time semantics
- Database schema requirements (timestamptz)
- TypeScript API patterns
- DST handling guidelines
- Audit hash stability requirements

✅ **docs/policies/time-migration.md** - Migration guide
- What changed overview
- Usage examples
- Testing validation steps
- Next steps (backfill, analytics)

### 2. TimeService Implementation

✅ **src/services/time/index.ts** - Comprehensive utilities
- `nowSystem()` / `nowBusiness(tenant)` - Current time helpers
- `createDualTimestamp(tenant)` - Dual timestamp generation
- `toSystemTime()` / `displayForTenant()` - Conversions
- `isSameBusinessDay()` - Business day operations
- `billingPeriod(year, month, tenant)` - Billing period calculation
- `normalizeToUtc()` - DST-aware normalization
- `fromDatabase()` / `toDatabase()` - DB format helpers

**Dependencies:**
- `luxon ^3.7.2` - IANA timezone support with DST handling
- `@types/luxon ^3.7.1` - TypeScript definitions

### 3. Database Migrations

✅ **database/migrations/20251025_add_dual_time_columns.sql**
- Added `business_time` and `system_time` columns to:
  - `subscriptions`
  - `invoices`
  - `audit_log`
  - `usage_summaries`
  - `billing_accounts`
- Backfilled existing data from `created_at`
- Created indexes on `business_time` for queries
- Validation checks ensure no NULL values

### 4. Type System Updates

✅ **src/domain/billing/core.ts** - Dual-time fields
- Updated interfaces: `CanonicalSubscription`, `CanonicalInvoice`, `CanonicalPaymentIntent`, `BillingAccount`
- Added `business_time: DateTime` and `system_time: DateTime`
- Deprecated legacy `createdAt`/`updatedAt` for backward compat

### 5. Lint Enforcement

✅ **eslint/rules/no-naive-date.cjs** - Custom ESLint rule
- Blocks `new Date()` and `Date.now()` 
- Enforces `TimeService.nowSystem()` / `TimeService.nowBusiness(tenant)`
- Allows inline disable comments for test fixtures
- Configured in `eslint.config.cjs` with error severity

### 6. Comprehensive Tests

✅ **tests/time/temporal-hygiene.spec.ts** - 33/33 passing
- Core API (nowSystem, nowBusiness, createDualTimestamp)
- DST transitions (spring forward, fall back)
- Business day operations (isSameBusinessDay, billing periods)
- Timezone conversions (displayForTenant, normalizeToUtc)
- Database conversions (fromDatabase, toDatabase)
- Audit hash stability

### 7. Storybook Proofs

✅ **stories/proofs/TemporalHygiene.stories.tsx** - Visual demos
- Invoice due dates across timezones
- Billing period boundaries
- Subscription lifecycle events
- DST transition resilience

## Validation Results

### Test Coverage
```bash
pnpm vitest run tests/time/temporal-hygiene.spec.ts
# ✅ 33 tests passing
```

### ESLint Enforcement
```bash
pnpm lint
# ✅ no-naive-date rule active across src/ and apps/
```

### Stories
```bash
pnpm storybook
# ✅ Proofs → Temporal Hygiene stories render correctly
```

## Key Decisions

1. **Luxon over Moment/date-fns**: IANA timezone support, immutability, ISO 8601 native
2. **Dual-time everywhere**: All domain entities get both business_time and system_time
3. **Backward compat**: Legacy timestamps deprecated but retained during migration
4. **ESLint enforcement**: Prevents accidental naive Date usage

## Technical Highlights

- **DST-aware**: Handles spring forward/fall back transparently via Luxon
- **Multi-tenant ready**: Each tenant maintains own business calendar
- **Audit integrity**: System time provides immutable ordering for forensics
- **Type-safe**: Full TypeScript integration with DateTime type

## Next Mission

✅ **B17.7 promoted to Current**: Polymorphic Account + metadata policy

## Files Created/Modified

**Created:**
- docs/policies/time.md
- docs/policies/time-migration.md
- src/services/time/index.ts
- database/migrations/20251025_add_dual_time_columns.sql
- eslint/rules/no-naive-date.cjs
- tests/time/temporal-hygiene.spec.ts
- stories/proofs/TemporalHygiene.stories.tsx

**Modified:**
- src/domain/billing/core.ts (added dual-time fields)
- eslint.config.cjs (enabled no-naive-date rule)
- package.json (added luxon dependencies)

---

**Agent:** Codex  
**Session:** 114  
**Mission File:** cmos/missions/sprint-17/B17.6_temporal-hygiene-dual-time.yaml  
**Backlog Entry:** cmos/missions/backlog.yaml (B17.6)

