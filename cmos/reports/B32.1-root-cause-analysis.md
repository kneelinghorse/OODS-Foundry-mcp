# B32.1 ChoroplethMap - Verified Root Cause Analysis

**Status:** BLOCKED
**Date:** 2025-11-29
**Author:** assistant

---

## Summary

The ChoroplethMap renders SVG paths with correct colors, but the map doesn't display properly because:

1. **Projection is not fitted to data** - shapes cover only ~20% of the viewport
2. **No basemap** - just floating shapes with no geographic context
3. **Sample GeoJSON is crude rectangles** - not real state boundaries

---

## Verified Root Cause

**ChoroplethMap ignores the fitted projection from context and creates its own unfitted projection.**

### The Bug

`ChoroplethMap.tsx` lines 721-724:
```typescript
const projectionObject = useMemo(() => {
  const projType = projection.type || 'mercator';
  return createProjection(projType, projection, dimensions);  // <-- Creates NEW projection
}, [projection, dimensions]);
```

This calls `createProjection()` which does NOT call `fitProjectionToFeatures()`.

### What Should Happen

`SpatialContainer` creates a fitted projection via `useSpatialProjection` hook:
```typescript
// useSpatialProjection.ts line 53
if (config.fitToData && features.features.length > 0) {
  fitProjectionToFeatures(proj, features, dimensions);
}
```

This fitted `project` function is passed in context (SpatialContainer line 298).

**But ChoroplethMap never uses it.** It gets `projection` config from context, then creates a brand new projection object without fitting.

### Evidence

Playwright inspection showed:
```
SVG dimensions: 1000x600
Path coverage: x=380-597 y=255-371
Coverage as % of SVG: 22% width, 19% height
```

The shapes are valid but clustered in one corner because the projection isn't fitted to fill the viewport.

---

## Secondary Issues

### No Basemap

The architecture (Section 4.1) specifies:
```
<SpatialContainer>
  ├── <MapBase>              # Projection + basemap
  │   ├── <RegionLayer>      # Choropleth fills
```

There is no `<MapBase>` component. There's no basemap layer showing the geographic context (other states, coastlines, etc.). The stories only show the 5 states that have data - the rest of the US is invisible.

### Sample Data Problem

The story GeoJSON uses bounding-box rectangles:
```typescript
// California in story
coordinates: [[[-124.4, 42.0], [-114.1, 42.0], [-114.1, 32.5], [-124.4, 32.5], [-124.4, 42.0]]]
```

This produces rectangles, not state shapes. Even if projection worked perfectly, you'd see 5 rectangles, not a map.

---

## Fix Required

**Minimum fix (projection only):**

In `ChoroplethMap.tsx`, instead of creating a new projection, use the `project` function from context or ensure `fitToData` is respected when creating the local projection.

**Proper fix (per architecture):**

1. ChoroplethMap should use the fitted projection from context
2. Add a basemap layer showing all geographic boundaries
3. Stories should use real GeoJSON (US states TopoJSON, not rectangles)

---

## What This Means for Sprint 32

| Issue | Impact | Fix Effort |
|-------|--------|------------|
| Projection not fitted | Map unusable | Small - use context projection |
| No basemap | No geographic context | Medium - add MapBase component |
| Fake GeoJSON in stories | Can't validate visually | Small - use real data |

The component architecture is sound. The implementation has a specific bug: ChoroplethMap ignores the fitted projection it should be using from context.

---

## Files Involved

| File | Issue |
|------|-------|
| `src/components/viz/spatial/ChoroplethMap.tsx:721-724` | Creates unfitted projection instead of using context |
| `src/components/viz/spatial/SpatialContext.tsx:29` | Provides `project` function that's never used |
| `src/components/viz/spatial/ChoroplethMap.stories.tsx` | Uses fake rectangular GeoJSON |

---

## Recommendation

This is a fixable bug, not an architectural failure. The projection fitting logic exists and works in `useSpatialProjection`. ChoroplethMap just doesn't use it.

Fix is straightforward: make ChoroplethMap use the projection from context instead of creating its own.

**I am not attempting any fixes per your direction. Awaiting your decision.**
