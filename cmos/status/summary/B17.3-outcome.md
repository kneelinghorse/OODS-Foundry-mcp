# B17.3 — Billing ACL v1: Provider Adapters

**Mission ID:** B17.3  
**Status:** ✅ Completed  
**Started:** 2025-10-24T22:00:00Z  
**Completed:** 2025-10-24T22:12:52Z  
**Duration:** ~13 minutes

## Objective

Establish the Billing Anti-Corruption Layer to isolate third-party provider models (Stripe/Chargebee/Zuora) behind adapters mapped to internal canonical billing types with boundary tests and linting.

## Deliverables

### ✅ 1. Canonical Billing Domain Types
- **File:** `src/domain/billing/core.ts`
- **Content:**
  - `BillingAccount` - Provider-agnostic account type
  - `CanonicalSubscription` - 7-state subscription model
  - `CanonicalInvoice` - 5-state invoice model
  - `CanonicalPaymentIntent` - Payment tracking
  - `ProviderMetadata` - Audit trail preservation
  - Helper functions: `formatAmount`, `isActiveSubscription`, etc.

### ✅ 2. Billing Events Infrastructure
- **File:** `src/domain/billing/events.ts`
- **Content:**
  - `BillingEvent` - Canonical event type
  - `BillingEventsRouter` - Event subscription & routing with deduplication
  - Event types mapping 15+ provider events to canonical types
  - Event handlers with tenant filtering

### ✅ 3. Provider Adapters
- **Files:**
  - `src/integrations/billing/adapter.ts` - Base interface & helpers
  - `src/integrations/billing/stripe-adapter.ts` - Stripe translation
  - `src/integrations/billing/chargebee-adapter.ts` - Chargebee translation
  - `src/integrations/billing/zuora-adapter.ts` - Zuora translation
  - `src/integrations/billing/index.ts` - Barrel export

**Features:**
- Complete `BillingAdapter` interface implementation
- Status mapping for all provider states
- Timestamp normalization to ISO 8601
- Provider ID prefixing (e.g., `stripe_sub_123`)
- Error handling with `TranslationError`

### ✅ 4. Comprehensive Tests (23 Tests Passing)
- **Files:**
  - `tests/integrations/billing/stripe.spec.ts` - 9 tests
  - `tests/integrations/billing/chargebee.spec.ts` - 7 tests
  - `tests/integrations/billing/zuora.spec.ts` - 7 tests

**Coverage:**
- Basic subscription translation
- Invoice translation with line items
- Payment intent translation
- Event translation
- Status mapping for all known states
- Error cases (missing fields, invalid types)
- Edge cases (trials, cancellations, refunds)

### ✅ 5. ESLint Rule: Provider Leakage Prevention
- **File:** `eslint/rules/no-provider-leakage.cjs`
- **Configuration:** `eslint.config.cjs`
- **Enforcement:**
  - Blocks provider-specific terms (Stripe, Chargebee, Zuora)
  - Blocks provider ID patterns (`sub_`, `in_`, `cus_`, etc.)
  - Allows in adapter modules and tests
  - Fails CI on violations

### ✅ 6. Storybook Proof Stories
- **File:** `stories/proofs/billing-acl.stories.tsx`
- **Stories:**
  - StripeTranslation - Shows Stripe → Canonical
  - ChargebeeTranslation - Shows Chargebee → Canonical
  - ZuoraTranslation - Shows Zuora → Canonical
  - AllProviders - Side-by-side comparison

**Demonstrates:**
- Visual proof of ACL working
- Provider metadata preservation
- Canonical types powering UI
- Currency formatting
- Status badge mapping

### ✅ 7. Comprehensive Documentation
- **File:** `docs/billing/billing-acl.md`
- **Content:**
  - Architecture diagram
  - Core principles (sovereignty, isolation, single responsibility)
  - Canonical type specifications
  - Adapter interface contract
  - Provider-specific mappings
  - Event router usage
  - ESLint enforcement
  - Testing strategy
  - Migration guide
  - Adding new providers
  - Troubleshooting
  - Best practices

## Success Metrics

| Criterion | Status | Evidence |
|-----------|--------|----------|
| Internal billing types with no vendor strings | ✅ | `src/domain/billing/core.ts` uses only canonical terminology |
| Provider adapters implement `translateSubscription()`, `translateInvoice()`, `translateEvent()` | ✅ | All three adapters implement full interface |
| Event ingestion routes through ACL with audit + tenancy metadata | ✅ | `BillingEventsRouter` includes tenant filtering and audit logging |
| CI lint fails when provider identifiers appear outside adapters | ✅ | `no-provider-leakage` rule configured and enforced |
| Storybook proof + tests demonstrate canonical objects powering UI | ✅ | 4 stories + 23 passing tests |

## Test Results

```
 ✓ tests/integrations/billing/stripe.spec.ts (9 tests) 8ms
 ✓ tests/integrations/billing/chargebee.spec.ts (7 tests) 9ms
 ✓ tests/integrations/billing/zuora.spec.ts (7 tests) 7ms
 
 Total: 23 tests passing
```

## Key Decisions

1. **7-State Subscription Model**
   - Covers full lifecycle: future → trialing → active → past_due → paused → pending_cancellation → canceled
   - Maps cleanly from all three providers

2. **5-State Invoice Model**
   - Simplified: draft → posted → paid/past_due → void
   - Sufficient for billing UI and reporting

3. **Provider ID Prefixing**
   - All internal IDs prefixed: `stripe_`, `chargebee_`, `zuora_`
   - Prevents collisions in multi-provider environments
   - Enables quick provider identification in logs

4. **Event Router Architecture**
   - Subscription-based pattern with tenant filtering
   - Built-in deduplication (5-minute window)
   - Async handler execution with error aggregation

5. **ESLint Enforcement**
   - Zero tolerance for provider leakage
   - Blocks imports, identifiers, string literals, type references
   - Configured per-file to allow adapter modules

## Artifacts

- **Core Types:** 4 canonical domain interfaces + helpers
- **Adapters:** 3 full implementations (Stripe, Chargebee, Zuora)
- **Tests:** 23 test cases (100% adapter coverage)
- **Stories:** 4 Storybook proofs
- **Lint Rule:** 1 custom ESLint rule
- **Docs:** 1 comprehensive guide (250+ lines)

## Next Steps

**B17.4 - Canonical Subscription & Invoice States** is now **Current**.

This mission will:
- Adopt the 7-state subscription + 5-state invoice state machines in UI
- Derive delinquency status from invoice state + aging
- Sync token mappings and Storybook stories

## Notes

The ACL successfully isolates provider complexity from core domain logic. The architecture enables:

1. **Provider Independence** - Switching from Stripe to Chargebee requires zero changes to UI/domain code
2. **Multi-Provider Support** - Can run Stripe for US customers and Chargebee for international simultaneously
3. **Compliance & Audit** - Provider metadata preserved for regulatory requirements
4. **Type Safety** - TypeScript enforces canonical types throughout the codebase
5. **Test Coverage** - Comprehensive adapter tests prevent regression on provider API changes

The ESLint rule provides continuous enforcement, preventing accidental provider leakage during development.

---

**Outcome:** ✅ Successfully delivered billing ACL with full provider adapter suite, comprehensive tests, enforcement, and documentation.

