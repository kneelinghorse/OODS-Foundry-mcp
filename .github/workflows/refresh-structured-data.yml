name: Refresh Structured Data

on:
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: 'Upstream OODS-Foundry ref (tag/sha/branch)'
        required: false
        default: 'main'
      version_tag:
        description: 'Version tag for artifacts (YYYY-MM-DD). Defaults to today (UTC).'
        required: false
  repository_dispatch:
    types: [oods-foundry-release]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: refresh-structured-data
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  # Update this when adopting the two-repo model in a fork.
  UPSTREAM_REPO: kneelinghorse/OODS-Foundry

jobs:
  refresh:
    name: refresh
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout MCP repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout upstream OODS-Foundry
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: ${{ github.event.inputs.upstream_ref || github.event.client_payload.upstream_ref || 'main' }}
          path: upstream/OODS-Foundry
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Setup Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml jsonschema

      - name: Install JS deps
        run: pnpm install --frozen-lockfile

      - name: Resolve version tag
        id: version
        shell: bash
        run: |
          VERSION_TAG="${{ github.event.inputs.version_tag }}"
          if [ -z "$VERSION_TAG" ]; then
            VERSION_TAG="${{ github.event.client_payload.version_tag }}"
          fi
          if [ -z "$VERSION_TAG" ]; then
            VERSION_TAG="$(date -u +%Y-%m-%d)"
          fi

          # Keep generatedAt stable per version to avoid PR churn on re-runs.
          GENERATED_AT="${VERSION_TAG}T00:00:00Z"

          echo "version_tag=$VERSION_TAG" >> "$GITHUB_OUTPUT"
          echo "generated_at=$GENERATED_AT" >> "$GITHUB_OUTPUT"

      - name: Capture baseline etags
        id: baseline
        shell: bash
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          from pathlib import Path

          path = Path("artifacts/structured-data/manifest.json")
          if not path.exists():
              print("present=false")
              raise SystemExit(0)

          manifest = json.loads(path.read_text(encoding="utf-8"))
          etags = {a.get("name"): a.get("etag") for a in (manifest.get("artifacts") or []) if a.get("name")}
          print("present=true")
          print("etags=" + json.dumps(etags, sort_keys=True))
          PY

      - name: Refresh structured data
        shell: bash
        run: |
          pnpm refresh:data -- \
            --upstream-root upstream/OODS-Foundry \
            --artifact-dir artifacts/structured-data \
            --version-tag "${{ steps.version.outputs.version_tag }}" \
            --generated-at "${{ steps.version.outputs.generated_at }}"

      - name: Remove upstream checkout
        run: rm -rf upstream/OODS-Foundry

      - name: Detect meaningful changes
        id: changes
        env:
          BASELINE_PRESENT: ${{ steps.baseline.outputs.present }}
          BASELINE_ETAGS: ${{ steps.baseline.outputs.etags }}
        shell: bash
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          import os
          from pathlib import Path

          baseline_present = os.environ.get("BASELINE_PRESENT") == "true"
          baseline_etags = json.loads(os.environ.get("BASELINE_ETAGS") or "{}")

          path = Path("artifacts/structured-data/manifest.json")
          if not path.exists():
              print("skip_pr=true")
              raise SystemExit(0)

          manifest = json.loads(path.read_text(encoding="utf-8"))
          current_etags = {a.get("name"): a.get("etag") for a in (manifest.get("artifacts") or []) if a.get("name")}

          changed = (not baseline_present) or current_etags != baseline_etags
          print(f"skip_pr={'false' if changed else 'true'}")
          PY

      - name: Reset working tree (no changes)
        if: steps.changes.outputs.skip_pr == 'true'
        run: |
          git checkout -- .
          git clean -fd

      - name: Build PR body
        if: steps.changes.outputs.skip_pr != 'true'
        id: pr-body
        shell: bash
        run: |
          BODY_PATH="${RUNNER_TEMP}/refresh-structured-data-pr-body.md"
          DELTA_FILE="cmos/planning/structured-data-delta-${{ steps.version.outputs.version_tag }}.md"

          {
            echo "Automated structured data refresh."
            echo ""
            echo "- Upstream: \`${{ env.UPSTREAM_REPO }}@${{ github.event.inputs.upstream_ref || github.event.client_payload.upstream_ref || 'main' }}\`"
            echo "- Version tag: \`${{ steps.version.outputs.version_tag }}\`"
            echo ""

            if [ -f "$DELTA_FILE" ]; then
              echo "## Delta report"
              echo ""
              cat "$DELTA_FILE"
            else
              echo "_Delta report not found at \`$DELTA_FILE\`._"
            fi
          } > "$BODY_PATH"

          echo "path=$BODY_PATH" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        if: steps.changes.outputs.skip_pr != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          add-paths: |
            cmos/planning
            artifacts/structured-data
          branch: automation/refresh-structured-data-${{ steps.version.outputs.version_tag }}
          delete-branch: true
          title: "chore: refresh structured data (${{ steps.version.outputs.version_tag }})"
          commit-message: "chore: refresh structured data (${{ steps.version.outputs.version_tag }})"
          body-path: ${{ steps.pr-body.outputs.path }}
          labels: structured-data, automation
