id: B41.3
title: Preferenceable Trait Story
status: Queued
sprint: Sprint 41
created: 2025-12-04
tags: [trait-story, preferenceable, settings, preferences, storybook]

objective: |
  Create a comprehensive Storybook story for the Preferenceable trait that demonstrates
  user preference management with JSONB storage, schema versioning, and namespace governance.

context: |
  Preferenceable is a core trait for user settings management. It provides:
  - Namespace-organized preferences (theme, notifications, display)
  - JSON Schema-backed validation
  - Schema versioning with migration support
  - Registry-driven UI generation

  Reference: traits/core/Preferenceable.trait.yaml
  Research: R21.5 Preferenceable Trait Implementation

  Key parameters:
  - namespaces: Allowed top-level keys (theme, notifications, display)
  - schemaVersion: Current schema version (SemVer)
  - allowUnknownNamespaces: Escape hatch for custom namespaces
  - registryNamespace: Registry ID for schema/UI bundles

deliverables:
  - path: stories/traits/Preferenceable.stories.tsx
    action: create
    details: |
      STRUCTURE (5 stories):

      1. OVERVIEW STORY
         Title: "1. Overview"
         Content:
         - Heading: "Preferenceable"
         - Subheading: "User preferences with schema versioning and namespace governance"
         - Problem/Solution cards:
           * Without: Scattered settings, no validation, migration nightmares
           * With: Centralized prefs, schema validation, versioned migrations
         - Key Fields:
           * preference_document - JSONB payload with version and preferences map
           * preference_metadata - Schema version, lastUpdated, migrations applied
           * preference_namespaces - Materialized list of active namespaces
           * preference_mutations - Cache invalidation counter
         - Used By: User, Organization, Workspace

      2. NAMESPACE EXPLORER STORY
         Title: "2. Namespace Explorer"
         Content:
         - Namespace chips/badges showing active namespaces
         - Collapsible panels for each namespace:
           * theme: mode (light/dark/system), density, accent color
           * notifications: email, push, in-app toggles per event type
           * display: timezone, date format, language
         - Add namespace capability (if allowUnknownNamespaces)
         - Namespace validation status

      3. PREFERENCE EDITOR STORY
         Title: "3. Preference Editor"
         Content:
         - JSON Schema-driven form generation
         - Real-time validation feedback
         - Default value handling
         - Nested preference editing (notifications.mention.email)
         - Reset to defaults action
         - Diff view (show what changed)

      4. SCHEMA VERSIONING STORY
         Title: "4. Schema Versioning"
         Content:
         - Version badge display (1.0.0, 1.1.0, etc.)
         - Migration history timeline
         - Schema diff visualization
         - Backward compatibility indicators
         - Migration preview (what will change)

      5. HOW IT WORKS STORY
         Title: "5. How It Works"
         Content:
         - PreferenceDocument schema definition
         - Namespace configuration
         - Schema registry integration
         - UI generation from JSON Schema
         - Migration pipeline
         - Cache invalidation via preference_mutations

      SAMPLE DATA:
      ```typescript
      const SAMPLE_PREFERENCES = {
        version: '1.0.0',
        preferences: {
          theme: {
            mode: 'system',
            density: 'comfortable',
            accentColor: 'blue'
          },
          notifications: {
            mention: { email: true, push: true, in_app: true },
            digest: { email: true, push: false, in_app: false },
            marketing: { email: false, push: false, in_app: false }
          },
          display: {
            timezone: 'America/New_York',
            dateFormat: 'MMM d, yyyy',
            language: 'en-US'
          }
        },
        metadata: {
          schemaVersion: '1.0.0',
          lastUpdated: '2025-12-04T10:30:00Z',
          source: 'user',
          migrationApplied: []
        }
      };
      ```

      STYLE:
      - Use form-like layouts for preference editing
      - Toggle switches for boolean preferences
      - Dropdowns for enum preferences
      - Nested sections for namespace organization

success_criteria:
  - All 5 stories render correctly
  - Preference editor shows validation
  - Namespace explorer properly organized
  - Schema versioning concept clear
  - TypeScript compiles cleanly

validation:
  - command: pnpm tsc --noEmit
    expected: No errors
  - manual: Test preference editing interactions

dependencies:
  - B41.2  # Communicable should be done first

notes: |
  Preferenceable integrates with Communicable for notification preferences.
  The story should show this connection.

  Key UX considerations:
  - Preference forms should be intuitive
  - Validation errors should be helpful
  - Migration warnings should be clear

  Reference existing preference UI patterns if available.
