id: B41.2
title: Communicable Trait Story
status: Queued
sprint: Sprint 41
created: 2025-12-04
tags: [trait-story, communicable, messaging, notifications, storybook]

objective: |
  Create a comprehensive Storybook story for the Communicable trait that demonstrates
  multi-channel messaging, template governance, delivery policies, and conversations.

context: |
  Communicable is a communication trait that unifies multi-channel delivery (email,
  SMS, push, in-app, webhook), template governance, and threaded conversations.

  Reference: traits/core/Communicable.trait.yaml
  Research: R20.1 Canonical Notification Model, R20.6 Message Systems Analysis

  Key components:
  - Channel catalog (provider configurations)
  - Template catalog (localized templates with variables)
  - Delivery policies (retry, throttle, quiet hours)
  - Messages (atomic payloads)
  - Conversations (threaded multi-party)
  - Message statuses (queued → sent → delivered → read)

  Dependencies: Preferenceable, Authable, Classifiable (optional)

deliverables:
  - path: stories/traits/Communicable.stories.tsx
    action: create
    details: |
      STRUCTURE (5 stories):

      1. OVERVIEW STORY
         Title: "1. Overview"
         Content:
         - Heading: "Communicable"
         - Subheading: "Multi-channel messaging with template governance and delivery policies"
         - Problem/Solution cards:
           * Without: Scattered notification code, no templates, inconsistent delivery
           * With: Unified channels, template system, policy enforcement, audit trail
         - Key Components:
           * channel_catalog - Provider configurations (SMTP, Twilio, FCM)
           * template_catalog - Localized templates with variables
           * delivery_policies - Retry/throttle/quiet hour rules
           * messages - Atomic message queue
           * conversations - Threaded discussions
         - Used By: User, Organization, Ticket, Order

      2. CHANNEL GRID STORY
         Title: "2. Channel Grid"
         Content:
         - Visual grid of available channels:
           * Email (SMTP/SendGrid/SES)
           * SMS (Twilio/Vonage)
           * Push (FCM/APNS)
           * In-App (WebSocket/Polling)
           * Webhook (HTTP callbacks)
         - Channel status badges (configured/active/error)
         - Provider configuration preview
         - Channel selection for message sending

      3. TEMPLATE SYSTEM STORY
         Title: "3. Template System"
         Content:
         - Template browser/drawer component
         - Template with variable placeholders:
           * {{ user.name }}
           * {{ order.id }}
           * {{ subscription.plan }}
         - Localization support (en, es, fr tabs)
         - Template preview with sample data
         - Variable validation badges

      4. DELIVERY POLICIES STORY
         Title: "4. Delivery Policies"
         Content:
         - Policy configuration cards:
           * Retry policy: max attempts, backoff strategy
           * Throttle policy: rate limits per channel
           * Quiet hours: time windows when delivery paused
         - Message lifecycle diagram:
           queued → sending → sent → delivered → read
                          ↓
                       failed → retrying
         - Delivery status timeline

      5. CONVERSATIONS STORY
         Title: "5. Conversations"
         Content:
         - ConversationViewer component demo
         - Threaded message display
         - Multi-party participants
         - Message status indicators
         - Reply/forward actions
         - Conversation lifecycle (open → resolved → archived)

      6. HOW IT WORKS STORY
         Title: "6. How It Works"
         Content:
         - Schema definition
         - Channel configuration example
         - Template creation example
         - Policy configuration example
         - Message sending flow
         - Integration with Preferenceable (user notification prefs)

      SAMPLE DATA:
      ```typescript
      const CHANNELS = [
        { type: 'email', provider: 'sendgrid', status: 'active' },
        { type: 'sms', provider: 'twilio', status: 'active' },
        { type: 'push', provider: 'fcm', status: 'configured' },
        { type: 'in_app', provider: 'websocket', status: 'active' },
      ];

      const TEMPLATES = [
        { id: 'welcome', name: 'Welcome Email', channels: ['email'] },
        { id: 'order_confirmation', name: 'Order Confirmation', channels: ['email', 'sms'] },
        { id: 'password_reset', name: 'Password Reset', channels: ['email'] },
      ];
      ```

success_criteria:
  - All 6 stories render correctly
  - Channel grid shows status badges
  - Template preview works with sample data
  - Delivery timeline visualizes message lifecycle
  - TypeScript compiles cleanly

validation:
  - command: pnpm tsc --noEmit
    expected: No errors
  - manual: Test all interactive elements

dependencies:
  - B41.1  # Taggable should be done first

notes: |
  This is one of the more complex trait stories due to the breadth of
  Communicable's functionality.

  Consider referencing existing components:
  - stories/domains/Billing/ for timeline patterns
  - MessageTimeline if it exists

  The story should help users understand:
  1. How to configure channels
  2. How to create and use templates
  3. How delivery policies work
  4. How conversations differ from notifications
