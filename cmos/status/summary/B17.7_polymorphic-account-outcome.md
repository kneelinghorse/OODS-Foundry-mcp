# B17.7 Polymorphic Account + Metadata Policy — Outcome

**Mission ID**: B17.7  
**Status**: ✅ Completed  
**Started**: 2025-10-25T16:00:00Z  
**Completed**: 2025-10-25T17:00:00Z  
**Agent**: codex

## Summary

Delivered polymorphic Account model with three archetypes (Person, Organization, Workspace), safe metadata policy preventing PII leakage, ESLint enforcement, comprehensive tests, migration scripts, Storybook demonstrations, and documentation.

## Deliverables Shipped

### 1. Core Domain Types

✅ **src/domain/accounts/core.ts**
- `AccountBase` interface with shared fields
- `AccountPerson` (B2C individual accounts)
- `AccountOrganization` (B2B company accounts)
- `AccountWorkspace` (team/project workspaces)
- `Contact` (PII segregation with retention policies)
- `AccountMembership` (User ↔ Account mapping via RBAC)
- Type guards: `isPersonAccount`, `isOrganizationAccount`, `isWorkspaceAccount`

### 2. Metadata Policy & Validation

✅ **src/domain/accounts/metadata-policy.ts**
- `MetadataPolicy` validator class
- Approved key allowlists per account type
- PII pattern detection (email, phone, SSN, credit card)
- Runtime validation with structured error reporting
- `sanitize()` helper to strip unapproved keys
- `extractPIIFromMetadata()` migration helper

### 3. Tests (35 passing)

✅ **tests/accounts/account-archetypes.spec.ts** (12 tests)
- Person, Organization, Workspace account creation
- Safe metadata examples
- Type guard validation
- Identity vs Account vs Contact separation

✅ **tests/accounts/metadata-policy.spec.ts** (23 tests)
- Approved key validation
- Unknown key detection
- PII pattern detection (email, phone, SSN, card)
- Nested metadata scanning
- Key-value validation
- Sanitization & migration helpers

### 4. ESLint Enforcement

✅ **eslint/rules/no-account-unsafe-metadata.cjs**
- Detects direct metadata writes without validation
- Requires `MetadataPolicy.validate()` before assignment
- Warns on spread operators bypassing validation
- Catches `Record<string, any>` type usage

### 5. Migration Script

✅ **database/migrations/20251025_migrate_billing_accounts_to_polymorphic.sql**
- Creates `accounts`, `contacts`, `account_memberships` tables
- Migrates legacy `billing_accounts` to polymorphic schema
- Extracts PII to `contacts` table
- Sanitizes metadata fields
- Adds validation constraints
- Post-migration verification queries

### 6. Documentation

✅ **docs/policies/account-archetypes.md**
- Overview of polymorphic model
- Account archetype specifications (Person, Org, Workspace)
- Contact table & PII segregation
- AccountMembership mapping
- Type guard usage
- Migration guide
- Best practices & antipatterns

✅ **docs/policies/account-metadata-policy.md**
- Safe metadata schemas per account type
- Runtime validation requirements
- PII detection patterns
- ESLint enforcement
- Sanitization for migration
- Testing requirements
- Compliance checklist
- Incident response

### 7. Storybook Stories

✅ **stories/domains/AccountArchetypes.stories.tsx**
- Person account example
- Organization account example
- Workspace account example
- Invalid metadata (PII detected) example
- All archetypes comparison
- Contact record visualization
- Account membership example

## Test Results

```
✓ tests/accounts/account-archetypes.spec.ts (12 tests) 4ms
✓ tests/accounts/metadata-policy.spec.ts (23 tests) 5ms

Test Files  2 passed (2)
     Tests  35 passed (35)
```

## Success Criteria Met

✅ Account union types defined (Person, Organization, Workspace) with explicit fields  
✅ Metadata policy doc + schema ensures only approved keys; PII fields in Contact table  
✅ Membership resolver maps Users ↔ Accounts via RBAC roles  
✅ Lint/test fails if code writes arbitrary JSON metadata  
✅ Storybook + docs show examples of each archetype and safe metadata usage  

## Key Architectural Decisions

1. **PII Segregation**: All PII (name, email, phone, address) lives in `contacts` table with retention policies, NOT in account metadata
2. **Polymorphic Model**: Three distinct account types rather than monolithic table with nullable fields
3. **Metadata Allowlist**: Only approved keys per account type; runtime validation required
4. **ESLint Guard Rail**: Static analysis prevents unsafe metadata writes at lint time
5. **Identity Separation**: User (authentication) ≠ Account (billing) ≠ Contact (PII)

## Integration Points

- **RBAC (B17.1)**: AccountMembership references `roles` table for permission mapping
- **Tenancy (B17.2)**: Accounts scoped to tenants via `tenantId` field
- **Billing ACL (B17.3)**: BillingAccount now deprecated; use polymorphic Account types
- **Temporal Hygiene (B17.6)**: All accounts use `business_time` and `system_time` fields

## Migration Path

For teams migrating from legacy `billing_accounts`:

1. Run migration script: `psql -f database/migrations/20251025_migrate_billing_accounts_to_polymorphic.sql`
2. Review metadata PII extraction: `/tmp/billing_accounts_metadata_review.csv`
3. Update code to import from `@domain/accounts`
4. Enable ESLint rule: `@oods/no-account-unsafe-metadata`
5. Add `MetadataPolicy.validate()` calls before metadata writes

## Next Mission

**B17.8**: Docs & Brownfield Guide v1 (promoted to Current)
- Document incremental adoption paths
- Figma/Storybook/CLI bridge references
- Brownfield integration patterns

## Artifacts

| Type          | Path                                                                  |
|---------------|-----------------------------------------------------------------------|
| Core Module   | `src/domain/accounts/{core.ts,metadata-policy.ts,index.ts}`          |
| Tests         | `tests/accounts/{account-archetypes.spec.ts,metadata-policy.spec.ts}`|
| ESLint Rule   | `eslint/rules/no-account-unsafe-metadata.cjs`                        |
| Migration     | `database/migrations/20251025_migrate_billing_accounts_to_polymorphic.sql` |
| Docs          | `docs/policies/{account-archetypes.md,account-metadata-policy.md}`   |
| Stories       | `stories/domains/AccountArchetypes.stories.tsx`                       |
| Outcome       | `cmos/status/summary/B17.7_polymorphic-account-outcome.md`           |

---

**Status**: Mission complete. All deliverables shipped, tested, and documented. ✅

