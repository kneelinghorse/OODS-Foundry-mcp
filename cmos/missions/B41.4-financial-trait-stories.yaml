id: B41.4
title: Financial Trait Stories (Payable + Metered)
status: Queued
sprint: Sprint 41
created: 2025-12-04
tags: [trait-story, payable, metered, billing, storybook]

objective: |
  Create Storybook stories for the Payable and Metered traits that demonstrate
  payment processing patterns and usage-based billing capabilities.

context: |
  These are domain-specific financial traits that complement Billable:
  - Billable: Subscription/plan management (already has story)
  - Payable: Payment processing, refunds, payment methods
  - Metered: Usage tracking, meter aggregation, overage handling

  Reference: traits/financial/Priceable.trait.yaml (for pricing patterns)
  Research: B17.5 Usage Ingest documentation

  These traits often work together on billing-related objects.

deliverables:
  - path: stories/traits/Payable.stories.tsx
    action: create
    details: |
      STRUCTURE (4 stories):

      1. OVERVIEW STORY
         Title: "1. Overview"
         Content:
         - Heading: "Payable"
         - Subheading: "Payment processing with provider abstraction and refund handling"
         - Problem/Solution cards:
           * Without: Direct provider coupling, manual refund tracking
           * With: Provider-agnostic API, automatic refund flows, audit trail
         - Key Fields:
           * payment_method - Current payment instrument
           * payment_history - List of payment attempts
           * refund_eligibility - Whether refund allowed
           * payment_status - pending/succeeded/failed/refunded
         - Used By: Invoice, Order, Subscription

      2. PAYMENT FLOW STORY
         Title: "2. Payment Flow"
         Content:
         - Payment lifecycle diagram:
           initiated → processing → succeeded/failed
                                        ↓
                                    refunded (partial/full)
         - Payment method selector (card, bank, wallet)
         - Status badges for each state
         - Retry flow for failed payments

      3. REFUND HANDLING STORY
         Title: "3. Refund Handling"
         Content:
         - Refund eligibility rules display
         - Partial vs full refund UI
         - Refund reason collection
         - Refund timeline
         - Policy enforcement (time window, status requirements)

      4. HOW IT WORKS STORY
         Title: "4. How It Works"
         Content:
         - Schema definition
         - Provider abstraction (Stripe, PayPal, etc.)
         - Payment method storage (tokenized)
         - Refund policy configuration
         - Integration with Invoice/Subscription

  - path: stories/traits/Metered.stories.tsx
    action: create
    details: |
      STRUCTURE (4 stories):

      1. OVERVIEW STORY
         Title: "1. Overview"
         Content:
         - Heading: "Metered"
         - Subheading: "Usage-based billing with meter aggregation and overage handling"
         - Problem/Solution cards:
           * Without: Manual usage tracking, billing discrepancies
           * With: Automated metering, real-time aggregation, overage alerts
         - Key Fields:
           * usage_events - Raw usage event stream
           * usage_aggregates - Rolled-up usage by period
           * current_usage - Real-time usage counter
           * usage_limits - Configured thresholds
         - Used By: Subscription, API Key, Resource

      2. METER TYPES STORY
         Title: "2. Meter Types"
         Content:
         - Meter unit examples:
           * api_calls - Count of API requests
           * storage_bytes - Storage consumption
           * compute_minutes - Processing time
           * bandwidth_gb - Data transfer
           * active_users - MAU/DAU counts
           * messages_sent - Message volume
           * seats - License seats
           * records - Database records
         - Meter visualization (gauges, progress bars)
         - Unit formatting

      3. USAGE DASHBOARD STORY
         Title: "3. Usage Dashboard"
         Content:
         - Current period usage summary
         - Usage over time chart (daily/weekly/monthly)
         - Limit indicators with warning thresholds
         - Overage calculation preview
         - Usage breakdown by meter type

      4. AGGREGATION STORY
         Title: "4. Aggregation"
         Content:
         - Aggregation periods: daily, weekly, monthly, billing_period
         - Rollup visualization (events → daily → billing)
         - Invoice line item generation from aggregates
         - Rate card application

      5. HOW IT WORKS STORY
         Title: "5. How It Works"
         Content:
         - Usage event schema
         - Aggregation pipeline
         - Threshold alerting
         - Billing integration
         - Performance considerations

      SAMPLE DATA:
      ```typescript
      const USAGE_EVENTS = [
        { meter: 'api_calls', value: 1, timestamp: '2025-12-04T10:00:00Z' },
        { meter: 'storage_bytes', value: 1024000, timestamp: '2025-12-04T10:00:00Z' },
      ];

      const USAGE_SUMMARY = {
        api_calls: { used: 8500, limit: 10000, unit: 'calls' },
        storage: { used: 4.2, limit: 10, unit: 'GB' },
        bandwidth: { used: 45, limit: 100, unit: 'GB' },
      };
      ```

success_criteria:
  - Both trait stories render correctly
  - Payment flow diagrams clear
  - Usage dashboard visualizes data properly
  - Meter types well documented
  - TypeScript compiles cleanly

validation:
  - command: pnpm tsc --noEmit
    expected: No errors
  - manual: Test interactive elements

dependencies:
  - B41.3  # Preferenceable should be done first

notes: |
  These traits integrate with the existing billing stories:
  - stories/domains/Billing/Invoice.stories.tsx
  - stories/domains/Billing/Subscription.stories.tsx
  - stories/domains/Billing/Usage.metered.stories.tsx

  Consider cross-linking to the SaaS Billing Flow pattern story.

  The Usage.metered story already exists - Metered trait story should
  reference it or consolidate if there's overlap.
