# B35.7 Dark Mode Overlay Bug - Failure Report

**Date:** 2025-12-03
**Mission:** B35.7-dark-mode-overlay-fix
**Status:** Blocked
**Agent:** Claude (assistant)

## Summary

Failed to fix the dark mode overlay/text visibility issue on the Docs/Contexts/Dark page after multiple attempts. The problem appears to be architectural rather than a simple CSS fix.

## What I Attempted

1. **Added dark-mode specific backdrop rules** to overlays.css - reverted, wrong diagnosis
2. **Changed `.docs-dark-surface` to use `data-theme="dark"`** instead of manual token overrides - caused worse regressions
3. **Extended token cascade selectors** in layers.css to include `[data-theme]` - broke other things
4. **Added missing `--cmp-text-secondary`** to component slots - partial improvement but not sufficient
5. **Removed `.context-dark` class** in favor of `data-theme` - made things worse

All changes were reverted.

## What I Think The Problem Is

### The Symptom
On the Docs/Contexts/Dark page (`/docs/docs-contexts-dark--docs`), text appears very low contrast or invisible against the dark background. The issue is inconsistent - some elements render correctly while others don't.

### The Suspected Root Cause

The page uses two different approaches to create dark surfaces:

1. **`.docs-dark-surface`** (in `ContextsDarkDoc.tsx`) - manually overrides `--cmp-*` tokens
2. **`.context-dark`** (in `DarkModeDemo.tsx`) - also manually overrides `--cmp-*` tokens

These classes try to simulate dark mode by directly setting component tokens like:
```css
.docs-dark-surface {
  --cmp-text-body: var(--theme-dark-text-primary, #f6f8ff);
  --cmp-text-muted: color-mix(in srgb, var(--theme-dark-text-primary, #f6f8ff) 62%, transparent);
  /* etc */
}
```

**The problem:** This approach bypasses the design system's token cascade:
```
html[data-theme='dark'] sets --theme-* tokens
    ↓
:root sets --sys-* from --theme-*
    ↓
:root sets --cmp-* from --sys-*
```

The cascade only triggers on `html[data-theme='dark']`. When you manually override `--cmp-*` on a nested element, you're fighting against:
- Inherited values from parent contexts
- Storybook's own theme switching
- Specificity conflicts with other selectors
- Missing tokens that aren't manually overridden (like `--cmp-text-secondary`)

### Why My Fixes Failed

When I tried to make `[data-theme='dark']` work on nested elements by adding it to the cascade selectors, I broke the assumption that theme tokens are set at the document root. The `--sys-*` and `--cmp-*` layers weren't designed to re-derive on nested elements.

### What I Don't Know

1. **Exact CSS specificity conflicts** - Would need DevTools inspection to see which rules are winning
2. **Whether the issue is Storybook-specific** - The MDX/docs renderer may have its own styles
3. **Why some elements work and others don't** - The `DarkModeDemo` buttons/chips render correctly but headings don't
4. **Original intent** - Was `.docs-dark-surface` meant as a temporary hack or a supported pattern?

## Recommendation

**Delete this page and rebuild it correctly.**

Time spent debugging: ~1 hour
Estimated time to rebuild from scratch: 15-30 minutes

A new implementation should either:

1. **Use a Storybook decorator** that sets `data-theme="dark"` on the story root, letting the token cascade work naturally
2. **Create a proper "island dark context" pattern** in the design system that's explicitly supported, not a CSS hack

The current `.docs-dark-surface` and `.context-dark` classes are technical debt - they work around the design system instead of using it.

## Files Involved

- `apps/explorer/src/stories/docs/ContextsDarkDoc.tsx` - uses `.docs-dark-surface`
- `apps/explorer/src/pages/DarkModeDemo.tsx` - uses `.context-dark`
- `apps/explorer/src/styles/index.css` - defines both classes
- `apps/explorer/src/styles/layers.css` - defines token cascade
- `stories/docs/Contexts.Dark.mdx` - MDX wrapper

## Lesson Learned

Don't try to fix CSS token architecture issues by patching individual selectors. If the pattern is fundamentally broken, rebuild it correctly.
