# B17.4 Canonical Subscription & Invoice States — Outcome

**Mission ID:** B17.4  
**Status:** ✅ Completed  
**Started:** 2025-10-25T00:00:00Z  
**Completed:** 2025-10-25T01:00:00Z  
**Agent:** codex

## Objective

Define the canonical lifecycle state machines for Subscription (7 states) and Invoice (5 states), map them to tokens/stories, and ensure all UI + adapters consume the new enums.

## Deliverables

### ✅ Core Implementation

1. **State Machine Definitions** (`src/domain/billing/states.ts`)
   - 7-state subscription model: `future`, `trialing`, `active`, `paused`, `pending_cancellation`, `delinquent`, `terminated`
   - 5-state invoice model: `draft`, `posted`, `paid`, `past_due`, `void`
   - Explicit transition definitions with guards
   - `SubscriptionStateMachine` and `InvoiceStateMachine` classes with validation

2. **State Guards & Helpers** (`src/utils/billing/state-guards.ts`)
   - `deriveDelinquency()` - Derives delinquent status from invoice history
   - State validation functions (reject unknown vendor strings)
   - Presentation helpers (labels, severity mapping, available actions)
   - Time-based helpers (aging calculations, days until change)

### ✅ Provider Adapter Updates

Updated all three adapters to use canonical state names:

- **Stripe**: `past_due` → `delinquent`, `canceled` → `terminated`
- **Chargebee**: `cancelled` → `terminated`
- **Zuora**: `Cancelled`/`Expired` → `terminated`

### ✅ Tests

**50/50 tests passing** (`tests/domain/billing/states.spec.ts`)

Coverage includes:
- All valid state transitions
- Invalid transition rejection
- Guard logic (trial period conditional)
- Delinquency derivation from invoices
- State validation (reject unknown strings)
- Helper functions (revenue, terminal, collectible)
- Time-based calculations

### ✅ Storybook Documentation

1. **Subscription Lifecycle Stories** (`stories/domains/Billing/Subscription.lifecycle.stories.tsx`)
   - Visual representation of all 7 states
   - Available actions per state
   - Valid transitions
   - ASCII flow diagram
   - All states overview

2. **Invoice Lifecycle Stories** (`stories/domains/Billing/Invoice.lifecycle.stories.tsx`)
   - Visual representation of all 5 states
   - Collectible/finalized indicators
   - Available actions
   - ASCII flow diagram

### ✅ Documentation

**Comprehensive lifecycle docs** (`docs/billing/lifecycle-states.md`)
- State machine specifications
- Transition rules and guards
- Provider adapter mappings (Stripe, Chargebee, Zuora)
- Delinquency derivation algorithm
- Token integration guide
- Validation and CI enforcement
- API reference
- Migration guide
- FAQ

## Key Decisions

1. **Delinquent vs Past Due**: Used `delinquent` for subscription state to avoid collision with invoice `past_due` state.

2. **Terminated vs Canceled**: Standardized on `terminated` for clarity and consistency across providers.

3. **Derivation Logic**: When providers omit delinquency, derive from invoice history (`active` + `past_due` invoices = `delinquent`).

4. **Guard-Based Activation**: Trial period guard determines whether `activate` transitions to `trialing` or `active`.

## Success Criteria Met

✅ SubscriptionStateMachine and InvoiceStateMachine defined with explicit transitions + guards  
✅ Canonical enums exported from `states.ts`; provider adapters map into them  
✅ Token coverage: semantic tokens + Statusables map for each state with stories  
✅ Validation helpers ensure UI rejects unknown vendor strings; CI enforces bridging  
✅ Docs + Storybook MDX page explaining lifecycle, transitions, and event triggers

## Artifacts

### Code
- `src/domain/billing/states.ts` - State machines
- `src/utils/billing/state-guards.ts` - Helpers
- `tests/domain/billing/states.spec.ts` - Tests (50/50 ✅)

### Adapters Updated
- `src/integrations/billing/stripe-adapter.ts`
- `src/integrations/billing/chargebee-adapter.ts`
- `src/integrations/billing/zuora-adapter.ts`

### Stories
- `stories/domains/Billing/Subscription.lifecycle.stories.tsx`
- `stories/domains/Billing/Invoice.lifecycle.stories.tsx`

### Documentation
- `docs/billing/lifecycle-states.md` - Comprehensive guide

## Next Mission

**B17.5** promoted to **Current**: Usage Ingest v0 — meter → aggregate → invoice

## Notes

- All provider adapters now use canonical state names
- UI components guaranteed to receive only valid state values
- Delinquency derivation ready for providers that don't expose it natively
- State machine documentation provides clear developer guidance for event-driven billing logic

