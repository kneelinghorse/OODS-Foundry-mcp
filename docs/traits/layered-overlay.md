# LayeredOverlay Trait

The LayeredOverlay trait enables composition of multiple visualization layers on a single map base. It supports stacking choropleth, symbol, route, and other layer types with deterministic z-ordering and opacity control.

## Overview

| Property | Value |
|----------|-------|
| **Trait ID** | `viz.spatial.LayeredOverlay` |
| **Category** | `viz.spatial` |
| **Family** | Layout |
| **Version** | 1.0.0 |

## Purpose

The LayeredOverlay trait serves three primary purposes:

1. **Layer Composition**: Stack multiple visualization layers on a single map
2. **Z-Ordering**: Control rendering order with deterministic z-index sorting
3. **Interaction Control**: Configure pan/zoom, layer toggling, and feature selection

## Use Cases

- **Multi-Layer Maps**: Combine choropleth regions with symbol points and route lines
- **Choropleth with Symbols**: Overlay point data on regional fills
- **Route Maps**: Display flow lines with underlying region boundaries
- **Heatmap Overlays**: Add density visualizations on base maps
- **Interactive Maps**: Enable layer visibility toggles and feature selection

## Basemap Types

### None
- **Use Case**: Custom base layer or no base
- **Description**: No base layer rendered
- **Best For**: Custom tile services, minimal visualizations

### Tile
- **Use Case**: Standard web map tiles
- **Description**: Raster tile base layer (e.g., OpenStreetMap, satellite)
- **Best For**: Street-level detail, navigation context

### Boundaries
- **Use Case**: Vector boundary outlines
- **Description**: Geographic boundary lines (countries, states, regions)
- **Best For**: Thematic maps, data visualization, clean aesthetic

## Layer Types

### regionFill
- **Type**: Choropleth fills
- **Z-Index Default**: `0` (renders first, behind other layers)
- **Use Case**: Color-coded regions, administrative boundaries
- **Rendering**: Rect/geoshape marks

### symbol
- **Type**: Points/bubbles
- **Z-Index Default**: `10`
- **Use Case**: Location markers, data points, bubble maps
- **Rendering**: Circle marks

### route
- **Type**: Flow lines
- **Z-Index Default**: `20` (renders last, on top)
- **Use Case**: Migration flows, trade routes, network connections
- **Rendering**: Line marks

### heatmap
- **Type**: Density visualization
- **Z-Index Default**: `5`
- **Use Case**: Population density, activity hotspots
- **Rendering**: Density marks (future)

### contour
- **Type**: Isolines
- **Z-Index Default**: `15`
- **Use Case**: Elevation, temperature, pressure contours
- **Rendering**: Contour marks (future)

## Parameters

### basemap
- **Type**: `enum`
- **Default**: `boundaries`
- **Values**: `none`, `tile`, `boundaries`
- **Description**: Type of basemap to use for the map base layer

### layers
- **Type**: `string` (JSON array)
- **Default**: `[]`
- **Description**: Array of layer configurations as JSON string
- **Format**: `[{ type: 'regionFill', zIndex: 0, opacity: 1.0 }, ...]`

### panZoom
- **Type**: `boolean`
- **Default**: `true`
- **Description**: Enable pan and zoom interactions

### layerToggle
- **Type**: `boolean`
- **Default**: `false`
- **Description**: Enable layer visibility toggle controls

### featureSelect
- **Type**: `boolean`
- **Default**: `true`
- **Description**: Enable click-to-select feature interactions

## Schema Fields

### basemap_type
Type of basemap (required, default: `boundaries`)

### layers
Array of layer configurations as JSON string (optional, default: `[]`)

### interaction_pan_zoom
Enable pan and zoom interactions (required, default: `true`)

### interaction_layer_toggle
Enable layer visibility toggle controls (required, default: `false`)

### interaction_feature_select
Enable click-to-select feature interactions (required, default: `true`)

### ordered_layers
Ordered layer configuration with deterministic z-ordering (generated automatically)

## Output Properties

### orderedLayers
- **Type**: `object`
- **Description**: Ordered layer configuration with deterministic z-ordering
- **Generated By**: `layer-compositor` utility
- **Structure**: `{ basemap: string, layers: LayerConfig[] }`

## Layer Configuration

Each layer in the `layers` array must have:

```typescript
{
  type: 'regionFill' | 'symbol' | 'route' | 'heatmap' | 'contour',
  zIndex: number,  // Lower = behind, higher = front
  opacity: number  // 0.0 to 1.0
}
```

## Z-Ordering Behavior

Layers are sorted by `zIndex` in ascending order:
- **Lower zIndex**: Renders first (behind other layers)
- **Higher zIndex**: Renders last (on top of other layers)
- **Same zIndex**: Preserves original order

### Default Z-Index Values

| Layer Type | Default Z-Index | Rendering Order |
|------------|----------------|-----------------|
| regionFill | 0 | First (behind) |
| heatmap | 5 | Second |
| symbol | 10 | Third |
| contour | 15 | Fourth |
| route | 20 | Last (front) |

## Examples

### Choropleth with Symbol Overlay

```typescript
{
  basemap_type: 'boundaries',
  layers: JSON.stringify([
    {
      type: 'regionFill',
      zIndex: 0,
      opacity: 1.0
    },
    {
      type: 'symbol',
      zIndex: 10,
      opacity: 0.8
    }
  ]),
  interaction_pan_zoom: true,
  interaction_feature_select: true
}
```

### Multi-Layer Route Map

```typescript
{
  basemap_type: 'tile',
  layers: JSON.stringify([
    {
      type: 'regionFill',
      zIndex: 0,
      opacity: 0.6
    },
    {
      type: 'symbol',
      zIndex: 10,
      opacity: 1.0
    },
    {
      type: 'route',
      zIndex: 20,
      opacity: 0.9
    }
  ]),
  interaction_pan_zoom: true,
  interaction_layer_toggle: true
}
```

### Simple Choropleth

```typescript
{
  basemap_type: 'boundaries',
  layers: JSON.stringify([
    {
      type: 'regionFill',
      zIndex: 0,
      opacity: 1.0
    }
  ]),
  interaction_pan_zoom: false,
  interaction_feature_select: true
}
```

## Integration with Other Traits

### Geocodable
The LayeredOverlay trait works with Geocodable to:
- Apply layers to detected geographic data
- Support both point and boundary layer types
- Handle geo field resolution for layer encoding

### HasProjection
The LayeredOverlay trait works with HasProjection to:
- Apply consistent projection to all layers
- Ensure proper coordinate transformation
- Maintain projection settings across composition

## Interaction Options

### Pan & Zoom
- **Enabled By**: `interaction_pan_zoom: true`
- **Behavior**: Drag to pan, scroll to zoom
- **Use Case**: Exploratory maps, detailed analysis

### Layer Toggle
- **Enabled By**: `interaction_layer_toggle: true`
- **Behavior**: Show/hide layer controls
- **Use Case**: Multi-layer maps, user-controlled visibility

### Feature Select
- **Enabled By**: `interaction_feature_select: true`
- **Behavior**: Click to select features
- **Use Case**: Interactive maps, data exploration

## Best Practices

1. **Set Z-Index Explicitly**: Always specify zIndex for predictable rendering order
2. **Use Appropriate Opacity**: Adjust opacity for layered visualizations to show underlying data
3. **Choose Basemap Wisely**: Select basemap based on visualization needs (boundaries for clean, tile for context)
4. **Enable Interactions**: Use interaction flags to match user needs
5. **Test Layer Ordering**: Verify z-ordering produces expected visual result

## Validation

The layer compositor validates:
- Layer type must be one of: `regionFill`, `symbol`, `route`, `heatmap`, `contour`
- zIndex must be an integer
- opacity must be between 0.0 and 1.0
- All required fields must be present

## Accessibility

- Layer controls must be keyboard accessible
- Screen reader announcements for layer visibility changes
- High contrast support for layer indicators
- See: A11Y-R-04

## References

- [Spatial Module Architecture](../../../cmos/foundational-docs/data-viz-part2/spatial-module/ARCHITECTURE.md)
- [Mission B31.3](../../../cmos/missions/B31.3-projection-overlay-traits.yaml)

